trigger: none

pool:
 vmImage: ubuntu-latest

  # - stage1 - init, validate and plan
  # - stage2 - code scanning
  # - stage3 - manual validation and apply

stages:
  - stage: initValidatePlan
    displayName: Init Validate and Apply
    jobs:
      - job: initPlan
        displayName: Init and Plan
        steps:
        - template: install-init.yaml

        - task: TerraformTask@5
          displayName: Terraform Plan
          inputs:
            provider: 'azurerm'
            command: 'plan'
            workingDirectory: '$(System.DefaultWorkingDirectory)/environment/dev'
            environmentServiceNameAzureRM: 'fire'


      - job: validate
        dependsOn: initPlan
        displayName: Validate
        steps:
        - task: TerraformInstaller@1
          inputs:
            terraformVersion: 'latest'
        - task: TerraformTask@5
          displayName: Terraform Init
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/environment/dev'
            backendServiceArm: 'fire'
            backendAzureRmStorageAccountName: 'statefilesdata'
            backendAzureRmContainerName: 'fire'
            backendAzureRmKey: 'dev.tfstate'
        - task: TerraformTask@5
          displayName: Terraform Validate
          inputs:
            provider: 'azurerm'
            command: 'validate'
            workingDirectory: '$(System.DefaultWorkingDirectory)/environment/dev'

  - stage: securityScan
    displayName: Security Scanning
    jobs:
      - job: tfsecScan
        displayName: tfsec-scanning
        steps:
        - task: tfsec@1
          displayName: tfsec
          inputs:
            version: 'v1.26.0'
            dir: '$(System.DefaultWorkingDirectory)'

      # - job: tflint
      #   steps:
      #   - task: CmdLine@2
      #     continueOnError: true
      #     inputs:
      #       script: 'tflint $(System.DefaultWorkingDirectory) --recusive -f junit > result.xml'
        
      #   - task: PublishTestResults@2
      #     inputs:
      #       testResultsFormat: 'JUnit'
      #       testResultsFiles: 'result.xml'

  - stage: apply
    displayName: Apply
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: manualValidation
        displayName: Manual Approval
        pool: server
        steps:
        - task: ManualValidation@1
          displayName: Manual Approval
          inputs:
            notifyUsers: 'achinta.dutta04@gmail.com'
            approvers: 'achinta.dutta04@gmail.com'

      - job: apply
        dependsOn: manualValidation
        displayName: Apply
        steps:
        - task: TerraformInstaller@1
          inputs:
            terraformVersion: 'latest'
        - task: TerraformTask@5
          displayName: Terraform Init
          inputs:
            provider: 'azurerm'
            command: 'init'
            workingDirectory: '$(System.DefaultWorkingDirectory)/environment/dev'
            backendServiceArm: 'fire'
            backendAzureRmStorageAccountName: 'statefilesdata'
            backendAzureRmContainerName: 'fire'
            backendAzureRmKey: 'dev.tfstate'

        - task: TerraformTask@5
          displayName: Terraform Apply
          inputs:
            provider: 'azurerm'
            command: 'apply'
            workingDirectory: '$(System.DefaultWorkingDirectory)/environment/dev'
            environmentServiceNameAzureRM: 'fire'
        